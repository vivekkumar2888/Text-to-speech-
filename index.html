<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Voice Studio — Client</title>
<style>
  :root{
    --bg:#0b0f14; --card:#0f1720; --muted:rgba(255,255,255,0.07);
    --accent1:#7c3aed; --accent2:#06b6d4; --text:#eef2ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto; background:linear-gradient(180deg,#06070a,#0b1020);
    color:var(--text); display:flex; justify-content:center; padding:28px;
  }
  .wrap{width:100%; max-width:960px;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px; padding:18px; border:1px solid var(--muted); box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  h1{margin:0 0 6px 0}
  .subtitle{opacity:0.8; margin-bottom:12px}
  textarea{width:100%; min-height:140px; padding:12px; border-radius:12px; background:#071021; border:1px solid rgba(255,255,255,0.03); color:var(--text); resize:vertical}
  .row{display:flex; gap:12px; margin-top:12px; flex-wrap:wrap}
  .col{flex:1 1 160px; min-width:140px}
  label{display:block; font-size:13px; margin-bottom:6px; opacity:0.9}
  select,input[type=range]{width:100%; padding:10px; border-radius:10px; background:#071021; border:1px solid rgba(255,255,255,0.03); color:var(--text)}
  .controls{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap}
  .btn{padding:10px 14px; border-radius:10px; border:2px solid var(--accent1); background:transparent; color:var(--accent1); font-weight:700; cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#fff; border:none}
  .btn.small{padding:8px 10px; font-size:13px}
  .samples{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:14px}
  .voice-card{background:#071021; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.03)}
  .voice-head{display:flex; align-items:center; gap:10px}
  .avatar{width:44px;height:44;border-radius:8px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800}
  .voice-actions{display:flex;gap:8px;margin-top:8px}
  audio{width:100%; margin-top:12px;}
  .muted{opacity:0.8}
  @media(max-width:640px){ .row{flex-direction:column} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>AI Voice Studio</h1>
      <div class="subtitle">Local playback + server MP3 downloads (ElevenLabs). Voice samples loaded from server (if available).</div>

      <textarea id="textInput" placeholder="Yahan apna text likho..."></textarea>

      <div class="row">
        <div class="col">
          <label>Voice (browser voices shown; server voices below)</label>
          <select id="browserVoiceSelect"></select>
        </div>
        <div class="col">
          <label>Speed: <span id="rateVal">1.0</span>x</label>
          <input id="rate" type="range" min="0.5" max="2" step="0.1" value="1">
        </div>
        <div class="col">
          <label>Pitch: <span id="pitchVal">1.0</span></label>
          <input id="pitch" type="range" min="0.5" max="2" step="0.1" value="1">
        </div>
      </div>

      <div class="controls">
        <button id="speakBtn" class="btn primary">Speak ▶</button>
        <button id="stopBtn" class="btn">Stop ⏹</button>
        <button id="downloadServerBtn" class="btn small">Server MP3 Download ↓</button>
        <div class="muted" style="margin-left:auto">Server: <span id="serverStatus">Checking...</span></div>
      </div>

      <audio id="player" controls></audio>

      <div style="margin-top:16px; display:flex; justify-content:space-between; align-items:center">
        <div style="font-weight:700">Server Voices</div>
        <div class="muted">Preview & select server voice for MP3</div>
      </div>

      <div class="samples" id="serverVoicesGrid">
        <!-- server voice cards will be injected here -->
      </div>

    </div>
  </div>

<script>
const SERVER_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : ''; 
// if you deploy server somewhere else, set SERVER_URL to that URL, e.g. 'https://my-tts-server.example'

const textInput = document.getElementById('textInput');
const browserVoiceSelect = document.getElementById('browserVoiceSelect');
const rate = document.getElementById('rate');
const pitch = document.getElementById('pitch');
const rateVal = document.getElementById('rateVal');
const pitchVal = document.getElementById('pitchVal');
const speakBtn = document.getElementById('speakBtn');
const stopBtn = document.getElementById('stopBtn');
const downloadServerBtn = document.getElementById('downloadServerBtn');
const player = document.getElementById('player');
const serverStatus = document.getElementById('serverStatus');
const serverVoicesGrid = document.getElementById('serverVoicesGrid');

let browserVoices = [];
let serverVoices = [];
let selectedServerVoiceId = null;

/* Load browser voices reliably */
function waitForBrowserVoices(timeout = 2000){
  return new Promise(resolve=>{
    const v = speechSynthesis.getVoices();
    if(v.length) return resolve(v);
    let resolved = false;
    const timer = setTimeout(()=>{ if(!resolved){ resolved=true; resolve(speechSynthesis.getVoices()); } }, timeout);
    speechSynthesis.onvoiceschanged = ()=>{ if(!resolved){ resolved=true; clearTimeout(timer); resolve(speechSynthesis.getVoices()); } };
  });
}

async function initBrowserVoices(){
  browserVoices = await waitForBrowserVoices(2500);
  browserVoiceSelect.innerHTML = '';
  browserVoices.forEach((v,i)=>{
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `${v.name} — ${v.lang}${v.default? ' (default)':''}`;
    browserVoiceSelect.appendChild(opt);
  });
  if(browserVoices.length === 0){
    const opt = document.createElement('option'); opt.value='-1'; opt.textContent = 'No browser voices available';
    browserVoiceSelect.appendChild(opt);
  }
}

/* Browser speak */
speakBtn.addEventListener('click', ()=>{
  const txt = (textInput.value || '').trim();
  if(!txt) return alert('Pehle text likho.');
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(txt);
  const idx = parseInt(browserVoiceSelect.value);
  if(!isNaN(idx) && browserVoices[idx]) u.voice = browserVoices[idx];
  u.rate = parseFloat(rate.value);
  u.pitch = parseFloat(pitch.value);
  speechSynthesis.speak(u);
});

/* stop */
stopBtn.addEventListener('click', ()=> speechSynthesis.cancel());

/* update ui for rate/pitch */
rate.addEventListener('input', ()=> rateVal.textContent = rate.value);
pitch.addEventListener('input', ()=> pitchVal.textContent = pitch.value);

/* Server voices fetch */
async function fetchServerVoices(){
  if(!SERVER_URL){ serverStatus.textContent = 'Server URL not set'; return; }
  try{
    serverStatus.textContent = 'Loading...';
    const resp = await fetch(SERVER_URL + '/voices');
    if(!resp.ok) throw new Error('Server responded ' + resp.status);
    const json = await resp.json();
    // ElevenLabs returns voices as { voices: [ { voice info } ] } or array. Normalize.
    const voicesList = json.voices || (Array.isArray(json) ? json : (json.data || []));
    serverVoices = voicesList;
    serverStatus.textContent = 'OK';
    renderServerVoices();
  }catch(err){
    console.warn('fetchServerVoices error', err);
    serverStatus.textContent = 'Unavailable';
    serverVoices = [];
    serverVoicesGrid.innerHTML = `<div style="color:#f88">Server unavailable or CORS blocked.</div>`;
  }
}

/* Render server voice cards */
function renderServerVoices(){
  serverVoicesGrid.innerHTML = '';
  if(!serverVoices || serverVoices.length === 0){
    serverVoicesGrid.innerHTML = `<div class="muted">No server voices found.</div>`;
    return;
  }
  serverVoices.forEach((v, idx)=>{
    const card = document.createElement('div'); card.className='voice-card';
    const head = document.createElement('div'); head.className='voice-head';
    const avatar = document.createElement('div'); avatar.className='avatar'; avatar.textContent = (v.name||'V').slice(0,2).toUpperCase();
    const meta = document.createElement('div'); meta.innerHTML = `<div style="font-weight:700">${v.name||'Unknown'}</div><div class="muted" style="font-size:13px">${v.language||v.lang || ''} ${v.preview_url? '' : ''}</div>`;
    head.appendChild(avatar); head.appendChild(meta);
    const sample = document.createElement('div'); sample.style.marginTop='8px';
    const sampleText = document.createElement('textarea'); sampleText.style.width='100%'; sampleText.style.minHeight='60px'; sampleText.value = v.preview_text || 'Hello, this is a sample preview.';
    const actions = document.createElement('div'); actions.className='voice-actions';
    const playBtn = document.createElement('button'); playBtn.className='btn small'; playBtn.textContent='Play (browser)';
    const useBtn = document.createElement('button'); useBtn.className='btn small primary'; useBtn.textContent='Select for MP3';
    const dlBtn = document.createElement('button'); dlBtn.className='btn small'; dlBtn.textContent='Download MP3';
    actions.appendChild(playBtn); actions.appendChild(useBtn); actions.appendChild(dlBtn);

    card.appendChild(head);
    card.appendChild(sampleText);
    card.appendChild(actions);

    playBtn.addEventListener('click', ()=> {
      // quick browser play: use browser voices (since server voice can't be played locally)
      // or use server synth to stream and play (but that downloads MP3). We'll use browser fallback:
      const t = sampleText.value || '';
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(t);
      if(browserVoices[0]) u.voice = browserVoices[0];
      u.rate = parseFloat(rate.value);
      u.pitch = parseFloat(pitch.value);
      speechSynthesis.speak(u);
    });

    useBtn.addEventListener('click', ()=>{
      selectedServerVoiceId = v.id || v.voice_id || v.voiceId || v.voice || null;
      // highlight selected card visually
      document.querySelectorAll('.voice-card').forEach(c=> c.style.border = '1px solid rgba(255,255,255,0.03)');
      card.style.border = '2px solid var(--accent2)';
      alert('Selected voice for MP3: ' + (v.name || v.id || 'unknown'));
    });

    dlBtn.addEventListener('click', ()=> {
      // quick download using this voice's id and sample text
      const t = sampleText.value || textInput.value || 'Hello from AI Voice Studio';
      if(!selectedServerVoiceId){
        // if user didn't select, try this card's voice id
        selectedServerVoiceId = v.id || v.voice_id || v.voiceId || v.voice || null;
      }
      downloadFromServer(t, selectedServerVoiceId);
    });

    serverVoicesGrid.appendChild(card);
  });
}

/* download MP3 from server using selectedServerVoiceId */
async function downloadFromServer(text, voiceId=null){
  if(!SERVER_URL){ alert('Server URL not set. Please set SERVER_URL in client script.'); return; }
  if(!text || !text.trim()) return alert('Enter text to synthesize.');
  const body = { text: text.trim(), voiceId: voiceId };
  try{
    downloadServerBtn.disabled = true; downloadServerBtn.textContent = 'Preparing...';
    const resp = await fetch(SERVER_URL + '/synthesize', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!resp.ok){
      const txt = await resp.text();
      throw new Error('Server error: ' + txt);
    }
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    // play in page
    player.src = url;
    // trigger download
    const a = document.createElement('a');
    a.href = url;
    a.download = 'tts_server_audio.mp3';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 30000);
  }catch(err){
    console.error('downloadFromServer error', err);
    alert('Download failed: ' + err.message);
  }finally{
    downloadServerBtn.disabled = false; downloadServerBtn.textContent = 'Server MP3 Download ↓';
  }
}

/* Download button event: synthesize with selected server voice (or default) */
downloadServerBtn.addEventListener('click', async ()=>{
  const text = (textInput.value || '').trim();
  if(!text) return alert('Enter text first.');
  await downloadFromServer(text, selectedServerVoiceId);
});

/* Init */
(async function init(){
  await initBrowserVoices();
  if(SERVER_URL) {
    await fetchServerVoices();
  } else {
    serverStatus.textContent = 'No server URL';
    serverVoicesGrid.innerHTML = `<div class="muted">Server not configured. To enable MP3 downloads, set SERVER_URL in client code to your server address (e.g. http://localhost:3000).</div>`;
  }
})();
</script>
</body>
</html>
